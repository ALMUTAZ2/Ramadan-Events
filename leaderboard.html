<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† - ÙÙˆØ§Ø²ÙŠØ± Ø±Ù…Ø¶Ø§Ù†</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    *{font-family:'Cairo',sans-serif}

    /* ØªØ£Ø«ÙŠØ± Ø§Ø­ØªØ±Ø§ÙÙŠ Ù„Ù…Ù† ÙŠØ¬Ù…Ø¹ (Ø§Ù„Ø£ÙˆÙ„ + Ø£Ø³Ø±Ø¹ Ø¥Ø¬Ø§Ø¨Ø©) */
    @keyframes winnerGlow {
      0% { box-shadow: 0 0 0 rgba(255,215,0,0.0); transform: scale(1.08); }
      50% { box-shadow: 0 0 28px rgba(255,215,0,0.65); transform: scale(1.11); }
      100% { box-shadow: 0 0 0 rgba(255,215,0,0.0); transform: scale(1.08); }
    }
    .winner-effect { animation: winnerGlow 2s infinite; }

    /* Ù†ÙØ³ Ø¥Ø­Ø³Ø§Ø³ ÙƒØ±ÙˆØª Ø§Ù„ØµÙˆØ±Ø© */
    .card-base{
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(14px);
      border-radius: 18px;
    }

    /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø© */
    .title-main{
      letter-spacing: .5px;
      text-shadow: 0 6px 18px rgba(0,0,0,.25);
    }
  </style>
</head>

<body class="bg-gradient-to-b from-blue-900 to-indigo-950 min-h-screen text-white">

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® (Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù…Ø«Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) -->
  <div class="bg-white/5 border-b border-white/10 p-3">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
      <span id="day-name" class="text-blue-400"></span>
      <span id="current-date" class="text-green-400"></span>
    </div>
  </div>

  <div class="p-6 max-w-5xl mx-auto">

    <!-- Ø¹Ù†ÙˆØ§Ù† Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙŠÙˆÙ… + Ø§Ù„ØªØ§Ø±ÙŠØ® ØªØ­ØªÙ‡Ø§ (Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©) -->
    <div class="text-center mb-6">
      <h1 class="title-main text-3xl md:text-4xl font-extrabold text-yellow-400 mb-2">Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…</h1>
      <div id="results-date" class="text-green-300 font-semibold"></div>
    </div>

    <!-- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† -->
    <div class="text-center text-green-400 font-bold mb-6">
      Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø§Ù„ÙŠÙˆÙ…: <span id="participants-count">0</span>
    </div>

    <!-- ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒØ±ÙˆØª Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©: Ø§Ù„Ø«Ø§Ù„Ø« ÙŠØ³Ø§Ø± - Ø§Ù„Ø£ÙˆÙ„ ÙˆØ³Ø· - Ø§Ù„Ø«Ø§Ù†ÙŠ ÙŠÙ…ÙŠÙ† -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-stretch">

      <!-- Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø« (ÙŠØ³Ø§Ø± Ø¨Ø§Ù„ØµÙˆØ±Ø©) -->
      <div class="md:order-1">
        <div id="third-card" class="card-base border-2 border-white/25 p-6 text-center">
          <i data-lucide="trophy" class="w-12 h-12 mx-auto text-orange-400 mb-2"></i>
          <div class="font-bold text-xl text-black/80 bg-white/0">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø«</div>
          <div id="third-place" class="mt-3"></div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø£ÙˆÙ„ (ÙˆØ³Ø· Ø¨Ø§Ù„ØµÙˆØ±Ø© + Ø£ÙƒØ¨Ø±) -->
      <div class="md:order-2">
        <div id="first-card" class="card-base border-2 border-yellow-400/35 p-8 text-center md:scale-110">
          <i data-lucide="trophy" class="w-16 h-16 mx-auto text-yellow-400 mb-2"></i>
          <div class="font-extrabold text-2xl text-yellow-400">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø£ÙˆÙ„</div>
          <div id="first-place" class="mt-3"></div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù†ÙŠ (ÙŠÙ…ÙŠÙ† Ø¨Ø§Ù„ØµÙˆØ±Ø©) -->
      <div class="md:order-3">
        <div id="second-card" class="card-base border-2 border-white/25 p-6 text-center">
          <i data-lucide="trophy" class="w-12 h-12 mx-auto text-gray-300 mb-2"></i>
          <div class="font-bold text-xl text-black/80 bg-white/0">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
          <div id="second-place" class="mt-3"></div>
        </div>
      </div>

    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div class="bg-white/10 rounded-2xl p-6">
      <h3 class="text-green-400 font-bold mb-4">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-green-400/20">
              <th class="p-3 text-right">Ø§Ù„Ù…Ø±ÙƒØ²</th>
              <th class="p-3 text-right">Ø§Ù„Ø§Ø³Ù…</th>
              <th class="p-3 text-right">Ø§Ù„Ù†Ù‚Ø§Ø·</th>
              <th class="p-3 text-right">Ø§Ù„ÙˆÙ‚Øª</th>
            </tr>
          </thead>
          <tbody id="results-table"></tbody>
        </table>
      </div>
    </div>

    <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© -->
    <div class="text-center mt-8">
      <button onclick="location.href='ramadan.html'"
        class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 px-8 py-3 rounded-xl">
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
      </button>
    </div>

  </div>

<script>
  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC5RYK1lGaJaMQJmOH85cqNgv6m7rbLS_A",
    authDomain: "ramadanmotaz-5570f.firebaseapp.com",
    projectId: "ramadanmotaz-5570f"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Ø´Ø±ÙŠØ· Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù„ÙˆÙŠ
  function updateDateBar(){
    const days=['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
    const now=new Date();
    document.getElementById('day-name').textContent=days[now.getDay()];
    document.getElementById('current-date').textContent=now.toLocaleDateString('ar-SA');
  }

  // Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ index.html (DD-MM-YYYY)
  function getTodayKey(){
    const n=new Date();
    const d=String(n.getDate()).padStart(2,'0');
    const m=String(n.getMonth()+1).padStart(2,'0');
    const y=n.getFullYear();
    return `${d}-${m}-${y}`;
  }

  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØªØ­Øª "Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…" Ù…Ø«Ù„ Ø§Ù„ØµÙˆØ±Ø©
  function setResultsTitleDate(){
    const now=new Date();
    // Ù…Ù…ÙƒÙ† ØªØ®Ù„ÙŠÙ‡ ar-SA Ø£Ùˆ Ù†ÙØ³ DD-MM-YYYY
    const hijriLike = now.toLocaleDateString('ar-SA'); 
    document.getElementById('results-date').textContent = `Ù†ØªØ§Ø¦Ø¬ ${hijriLike}`;
  }

  function safeNum(x, fallback=0){
    const n = Number(x);
    return Number.isFinite(n) ? n : fallback;
  }

  function placeHTML(p, isFastest){
    const name = p.playerName || '';
    const score = (p.score ?? 0);
    const time = safeNum(p.totalTime, 0).toFixed(2);

    return `
      <div class="font-bold text-lg">${name}</div>
      <div class="text-yellow-300 font-semibold">${score} Ù†Ù‚Ø·Ø©</div>
      <div class="opacity-75">${time} Ø«Ø§Ù†ÙŠØ©</div>
      ${isFastest ? `<div class="text-yellow-200 text-sm mt-2">ğŸ”¥ Ø£Ø³Ø±Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…</div>` : ``}
    `;
  }

  async function fetchResults(){
    const today = getTodayKey();

    const snap = await db.collection('scores')
      .where('participationDate','==',today)
      .orderBy('score','desc')
      .orderBy('totalTime','asc')
      .get();

    const results=[];
    snap.forEach(d=> results.push(d.data()||{}));

    // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
    document.getElementById('participants-count').textContent = results.length;

    // Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬
    if(results.length === 0){
      document.getElementById('first-place').innerHTML = `<div class="opacity-80">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯</div>`;
      document.getElementById('second-place').innerHTML = `<div class="opacity-80">â€”</div>`;
      document.getElementById('third-place').innerHTML  = `<div class="opacity-80">â€”</div>`;
      document.getElementById('results-table').innerHTML = `
        <tr class="border-b border-white/10">
          <td class="p-3" colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ÙŠÙˆÙ… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td>
        </tr>`;
      return;
    }

    // Top 3
    const top3 = results.slice(0,3);

    // Ø£Ø³Ø±Ø¹ Ø¥Ø¬Ø§Ø¨Ø© Ø¶Ù…Ù† Ø§Ù„Ø«Ù„Ø§Ø«Ø© ÙÙ‚Ø·
    const fastest = top3.reduce((a,b)=> safeNum(a.totalTime,999999) < safeNum(b.totalTime,999999) ? a : b);

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ²
    if(top3[0]){
      const isFast = (top3[0].playerName === fastest.playerName) && (safeNum(top3[0].totalTime) === safeNum(fastest.totalTime));
      document.getElementById('first-place').innerHTML = placeHTML(top3[0], isFast);

      // Ø¥Ø°Ø§ Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ø£Ø³Ø±Ø¹ -> ØªØ£Ø«ÙŠØ± Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¹Ù„Ù‰ ÙƒØ±Øª Ø§Ù„Ø£ÙˆÙ„
      const firstCard = document.getElementById('first-card');
      if(isFast) firstCard.classList.add('winner-effect');
      else firstCard.classList.remove('winner-effect');
    }

    if(top3[1]){
      const isFast = (top3[1].playerName === fastest.playerName) && (safeNum(top3[1].totalTime) === safeNum(fastest.totalTime));
      document.getElementById('second-place').innerHTML = placeHTML(top3[1], isFast);
    } else {
      document.getElementById('second-place').innerHTML = `<div class="opacity-80">â€”</div>`;
    }

    if(top3[2]){
      const isFast = (top3[2].playerName === fastest.playerName) && (safeNum(top3[2].totalTime) === safeNum(fastest.totalTime));
      document.getElementById('third-place').innerHTML = placeHTML(top3[2], isFast);
    } else {
      document.getElementById('third-place').innerHTML = `<div class="opacity-80">â€”</div>`;
    }

    // Ø¬Ø¯ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('results-table').innerHTML = results.map((r,i)=>`
      <tr class="border-b border-white/10">
        <td class="p-3">${i+1}</td>
        <td class="p-3">${r.playerName || ''}</td>
        <td class="p-3">${r.score ?? 0}</td>
        <td class="p-3">${safeNum(r.totalTime,0).toFixed(2)} Ø«Ø§Ù†ÙŠØ©</td>
      </tr>
    `).join('');
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    updateDateBar();
    setResultsTitleDate();
    lucide.createIcons();
    try{
      await fetchResults();
    }catch(e){
      console.error(e);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
    }
  });
</script>

</body>
</html>
